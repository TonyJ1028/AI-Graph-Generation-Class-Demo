# 教师端和白板端连接测试指南

## 🔌 连接问题诊断

### 问题描述
教师端和白板端无法正常连接和同步数据。

### 🔍 问题分析

#### 1. 会话ID不匹配
- **教师端**: 通过API创建新的会话ID
- **白板端**: 默认使用基于时间戳的演示会话ID
- **结果**: 两端连接到不同的会话，无法通信

#### 2. WebSocket连接状态
- 后端WebSocket服务正常运行
- 前端连接代码正确
- 但会话隔离导致消息无法传递

## ✅ 修复方案

### 1. 添加白板连接功能
在教师端头部添加了"打开白板"按钮：
- 🖥️ **Monitor图标按钮**: 一键打开对应会话的白板
- 📋 **会话ID显示**: 显示当前会话的前8位字符
- 🔗 **自动URL生成**: 自动生成带会话ID的白板链接

### 2. 会话同步机制
白板端支持通过URL参数接收会话ID：
```
http://localhost:3002?session=YOUR_SESSION_ID
```

## 🧪 连接测试步骤

### 步骤1: 启动所有服务
```bash
# 方式1: 一键启动
./start-all.sh

# 方式2: 手动启动
cd backend-api && pnpm run dev          # 端口3001
cd teacher-control && pnpm run dev      # 端口3003  
cd whiteboard-display && pnpm run dev   # 端口3002
```

### 步骤2: 打开教师端
1. 在浏览器中访问: http://localhost:3003
2. 等待页面加载完成
3. 检查右上角连接状态（绿点 = 已连接）
4. 记录显示的会话ID

### 步骤3: 连接白板端
**方式1: 使用按钮（推荐）**
1. 在教师端点击右上角的🖥️按钮
2. 系统会自动打开新标签页显示白板端
3. 白板端会自动连接到相同的会话

**方式2: 手动连接**
1. 复制教师端显示的完整会话ID
2. 在新标签页打开: http://localhost:3002?session=YOUR_SESSION_ID
3. 替换YOUR_SESSION_ID为实际的会话ID

### 步骤4: 验证连接
1. **检查连接状态**:
   - 教师端右上角应显示绿色连接指示器
   - 白板端应显示"已连接"状态

2. **测试数据同步**:
   - 在教师端选择模式（如"图像生成"）
   - 观察白板端是否同步显示相同模式
   - 在教师端上传图片或输入文字
   - 检查白板端是否实时更新

3. **测试生成功能**:
   - 在教师端完成图像生成
   - 验证结果是否在白板端同步显示

## 🔧 故障排除

### 连接失败的常见原因

#### 1. 会话ID不匹配
**症状**: 教师端操作，白板端无反应
**解决**: 确保使用相同的会话ID连接

#### 2. WebSocket连接失败
**症状**: 连接状态显示红色/未连接
**检查**:
- 后端服务是否正常运行 (http://localhost:3001/health)
- 浏览器控制台是否有WebSocket错误
- 防火墙是否阻止连接

#### 3. 端口冲突
**症状**: 服务无法启动
**解决**: 
```bash
# 释放端口
lsof -ti:3001 | xargs kill -9
lsof -ti:3002 | xargs kill -9  
lsof -ti:3003 | xargs kill -9
```

#### 4. 浏览器缓存问题
**症状**: 页面显示异常或功能不正常
**解决**: 
- 硬刷新页面 (Ctrl+F5 或 Cmd+Shift+R)
- 清除浏览器缓存
- 使用无痕模式测试

## 📊 连接状态检查

### 1. 后端服务检查
```bash
curl http://localhost:3001/health
# 应返回: {"status":"ok","timestamp":...}
```

### 2. WebSocket连接检查
```bash
node test-websocket-connection.js
```

### 3. 浏览器开发者工具检查
1. 按F12打开开发者工具
2. 查看Console标签的连接日志
3. 查看Network标签的WebSocket连接
4. 确认没有CORS或安全策略错误

## 🎯 预期行为

### 正常连接状态
- ✅ 教师端显示绿色连接指示器
- ✅ 白板端显示"已连接到会话: XXX"
- ✅ 教师端操作实时同步到白板端
- ✅ 模式切换、内容更新都能同步

### 数据同步测试
1. **模式同步**: 教师端切换模式 → 白板端同步显示
2. **内容同步**: 教师端上传图片 → 白板端显示预览
3. **结果同步**: 教师端生成完成 → 白板端显示结果
4. **状态同步**: 教师端显示进度 → 白板端同步进度

## 🚀 快速连接指南

### 一键连接流程
1. 启动服务: `./start-all.sh`
2. 打开教师端: http://localhost:3003
3. 点击🖥️按钮打开白板端
4. 开始使用！

### 手动连接流程
1. 启动服务
2. 打开教师端: http://localhost:3003
3. 复制会话ID
4. 打开白板端: http://localhost:3002?session=SESSION_ID
5. 验证连接状态

## 📞 技术支持

如果连接问题仍然存在：

1. **收集信息**:
   - 浏览器控制台错误日志
   - 后端服务器日志
   - 网络连接状态
   - 使用的浏览器和版本

2. **尝试解决**:
   - 重启所有服务
   - 清除浏览器缓存
   - 尝试不同的浏览器
   - 检查防火墙设置

3. **联系支持**:
   - 提供详细的错误信息
   - 说明重现步骤
   - 附上相关日志

---

**更新时间**: 2024年1月13日  
**版本**: 1.0.2  
**状态**: ✅ 连接问题已修复
